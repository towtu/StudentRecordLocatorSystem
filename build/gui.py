
# This file was generated by the Tkinter Designer by Parth Jadhav
# https://github.com/ParthJadhav/Tkinter-Designer


from pathlib import Path
import sys
import platform
try:
    import ctypes
except Exception:
    ctypes = None

# from tkinter import *
# Explicit imports to satisfy Flake8
from tkinter import (
    Tk,
    Canvas,
    Entry,
    Text,
    Button,
    PhotoImage,
    Toplevel,
    StringVar,
    OptionMenu,
    Label,
    messagebox,
    Frame,
    Scrollbar,
    LEFT,
    RIGHT,
    BOTH,
    Y,
    VERTICAL,
    NW,
)
from PIL import ImageTk, Image, ImageChops
import csv


OUTPUT_PATH = Path(__file__).parent
ASSETS_PATH = OUTPUT_PATH / Path(r"C:\Users\Joseph\Documents\Tkinter\Tkinter-Designer\build\build\assets\frame0")


def relative_to_assets(path: str) -> Path:
    return ASSETS_PATH / Path(path)


def make_dpi_aware() -> None:
    """Make the process DPI aware on Windows to avoid blurry Tk windows.

    This tries several Windows APIs in preference order:
    1. SetProcessDpiAwarenessContext (per-monitor v2) if available
    2. shcore.SetProcessDpiAwareness(PROCESS_PER_MONITOR_DPI_AWARE)
    3. user32.SetProcessDPIAware (fallback)

    Only runs on Windows and will silently no-op on other platforms or if ctypes is not available.
    """
    if platform.system().lower() != "windows":
        return
    if not ctypes:
        return
    try:
        user32 = ctypes.windll.user32
        # Preferred: per-monitor v2 (Windows 10+)
        try:
            if hasattr(user32, "SetProcessDpiAwarenessContext"):
                # DPI_AWARENESS_CONTEXT_PER_MONITOR_AWARE_V2 = -4
                user32.SetProcessDpiAwarenessContext(ctypes.c_void_p(-4))
                return
        except Exception:
            pass

        # Next: shcore.SetProcessDpiAwareness (Windows 8.1+)
        try:
            shcore = ctypes.windll.shcore
            shcore.SetProcessDpiAwareness(2)  # PROCESS_PER_MONITOR_DPI_AWARE
            return
        except Exception:
            pass

        # Fallback: system DPI aware
        try:
            user32.SetProcessDPIAware()
        except Exception:
            pass
    except Exception:
        # Any failure - don't crash the app for DPI setup
        return


make_dpi_aware()

window = Tk()

window.geometry("996x627")
window.configure(bg = "#FFFFFF")
window.title("LocatR")
# Create an icon image using the PhotoImage class imported from tkinter.
# Use relative_to_assets so the path is resolved against the generated assets folder.
try:
    photo = PhotoImage(file=relative_to_assets("Logo.png"))
    window.iconphoto(False, photo)
except Exception:
    # If loading the icon fails, continue without setting it.
    photo = None


# Main canvas for the window background
canvas = Canvas(
    window,
    bg = "#FFFFFF",
    height = 627,
    width = 996,
    bd = 0,
    highlightthickness = 0,
    relief = "ridge"
)
canvas.place(x = 0, y = 0)

# Create a frame to hold the scrollable list
list_frame = Frame(window, bg="#FFFFFF")
list_frame.place(x=0, y=170, width=996, height=457)  # Start just below column headers

# Create a canvas for the scrollable content
list_canvas = Canvas(
    list_frame,
    bg="#FFFFFF",
    height=391,
    width=996,
    bd=0,
    highlightthickness=0,
)
list_canvas.pack(side=LEFT, fill=BOTH, expand=True)

# Add a scrollbar
scrollbar = Scrollbar(list_frame, orient=VERTICAL, command=list_canvas.yview)
scrollbar.pack(side=RIGHT, fill=Y)
list_canvas.configure(yscrollcommand=scrollbar.set)

# Create a frame inside the canvas to hold the student rows
students_frame = Frame(list_canvas, bg="#FFFFFF")
list_canvas.create_window((0, 0), window=students_frame, anchor=NW, width=996)

# Configure scrolling
def configure_scroll_region(event):
    list_canvas.configure(scrollregion=list_canvas.bbox("all"))
students_frame.bind("<Configure>", configure_scroll_region)

entry_image_1 = PhotoImage(
    file=relative_to_assets("entry_11.png"))
entry_bg_1 = canvas.create_image(
    186.5,
    64.0,
    image=entry_image_1
)
entry_1 = Entry(
    bd=0,
    bg="#FFFFFF",
    fg="#000716",
    font=("Inter", 14),
    highlightthickness=0
)
entry_1.place(
    x=85.0,
    y=42.5,
    width=250.0,
    height=45.0
)
# Bind search: filter students by student id or name as user types
entry_1.bind("<KeyRelease>", lambda e: render_students())

canvas.create_text(
    40.0,
    143.66665649414062,
    anchor="nw",
    text="STUDENT ID",
    fill="#000000",
    font=("Inter", 20 * -1)
)

canvas.create_text(
    278.0,
    144.0,
    anchor="nw",
    text="NAME",
    fill="#000000",
    font=("Inter", 20 * -1)
)

canvas.create_text(
    492.0,
    144.0,
    anchor="nw",
    text="COURSE",
    fill="#000000",
    font=("Inter", 20 * -1)
)

canvas.create_text(
    678.0,
    144.0,
    anchor="nw",
    text="LOCATION",
    fill="#000000",
    font=("Inter", 20 * -1)
)

canvas.create_text(
    862.0,
    143.66665649414062,
    anchor="nw",
    text="ACTION",
    fill="#000000",
    font=("Inter", 20 * -1)
)

canvas.create_rectangle(
    -1.0,
    128.0,
    996.00048828125,
    129.0,
    fill="#C2B9B9",
    outline="")

button_image_1 = PhotoImage(
    file=relative_to_assets("button_1.png"))
button_1 = Button(
    image=button_image_1,
    borderwidth=0,
    highlightthickness=0,
    command=lambda: open_add_student_window(),
    relief="flat"
)
button_1.place(
    x=729.0,
    y=27.0,
    width=245.0,
    height=73.0
)

# Preload the edit icon once and keep a reference to avoid it being garbage-collected
try:
    button_image_2 = Image.open(relative_to_assets("button_edit.png"))
    button_image_2 = button_image_2.resize((80, 26))
    button_image_2 = ImageTk.PhotoImage(button_image_2)
    
    print("success")
except Exception as e:
    button_image_2 = None
    print(e)

# Background for list area
canvas.create_rectangle(
    0.0,
    170.0,
    996.0,
    627.0,
    fill="#FFFFFF",
    outline="")

# --- Student data and UI management ---
students = []
action_buttons = []
STUDENTS_CSV = OUTPUT_PATH / "students.csv"

# Constants for text display
MAX_NAME_LENGTH = 25  # characters
MAX_COURSE_LENGTH = 20  # characters

def truncate_text(text: str, max_length: int) -> str:
    """Truncate text and add ellipsis if too long."""
    if len(text) <= max_length:
        return text
    return text[:max_length-3] + "..."


def load_students_from_csv() -> None:
    students.clear()
    try:
        if STUDENTS_CSV.exists():
            with open(STUDENTS_CSV, newline="", encoding="utf-8") as f:
                reader = csv.DictReader(f)
                for row in reader:
                    # Ensure keys: student_id, name, course, location
                    students.append({
                        "student_id": row.get("student_id", ""),
                        "name": row.get("name", ""),
                        "course": row.get("course", ""),
                        "location": row.get("location", ""),
                    })
    except Exception:
        # If CSV is malformed or unreadable, ignore and start fresh
        students.clear()


def save_students_to_csv() -> None:
    try:
        with open(STUDENTS_CSV, "w", newline="", encoding="utf-8") as f:
            fieldnames = ["student_id", "name", "course", "location"]
            writer = csv.DictWriter(f, fieldnames=fieldnames)
            writer.writeheader()
            for s in students:
                writer.writerow({
                    "student_id": s.get("student_id", ""),
                    "name": s.get("name", ""),
                    "course": s.get("course", ""),
                    "location": s.get("location", ""),
                })
    except Exception:
        # Don't crash the UI on disk errors
        pass


def render_students() -> None:
    # Clear previous content
    for widget in students_frame.winfo_children():
        widget.destroy()
    action_buttons.clear()

    # Determine which students match the search query (student id or name)
    query = ""
    try:
        query = entry_1.get().strip().lower()
    except Exception:
        query = ""

    visible = []
    if query:
        for i, s in enumerate(students):
            if query in str(s.get("student_id", "")).lower() or query in str(s.get("name", "")).lower():
                visible.append((i, s))
    else:
        visible = list(enumerate(students))

    row_height = 46
    for row_pos, (idx, s) in enumerate(visible):
        # Create a frame for this row
        row_frame = Frame(students_frame, bg="#FFFFFF", height=row_height)
        row_frame.pack(fill="x", pady=4)
        row_frame.pack_propagate(False)  # Maintain fixed height

        # Calculate y position for consistent spacing
        y = row_height/2  # Center text vertically in row
        
        # Student ID (fixed width, no truncation needed)
        Label(row_frame, 
              text=s.get("student_id", ""),
              font=("Inter", 13),
              bg="#FFFFFF",
              anchor="w").place(x=40, y=y-10, width=150)
        
        # Name (truncated if too long)
        Label(row_frame,
              text=truncate_text(s.get("name", ""), MAX_NAME_LENGTH),
              font=("Inter", 13),
              bg="#FFFFFF",
              anchor="w").place(x=230, y=y-10, width=200)
        
        # Course (truncated if too long)
        Label(row_frame,
              text=truncate_text(s.get("course", ""), MAX_COURSE_LENGTH),
              font=("Inter", 13),
              bg="#FFFFFF",
              anchor="w").place(x=450, y=y-10, width=200)
        
        # Location (usually short, no truncation needed)
        Label(row_frame,
              text=s.get("location", ""),
              font=("Inter", 13),
              bg="#FFFFFF",
              anchor="w").place(x=695, y=y-10, width=100)

        # Create an Edit button for each row (opens edit dialog with delete)
        if button_image_2:
            btn = Button(row_frame, 
                         image=button_image_2, 
                         borderwidth=0, 
                         highlightthickness=0, 
                         command=lambda i=idx: open_edit_student_window(i),  
                         relief="flat",
                         bg="#FFFFFF"
            ) # keep reference on the widget
            btn.image = button_image_2
        else:
            btn = Button(row_frame, text="Edit", command=lambda i=idx: open_edit_student_window(i))
        # Place button near the ACTION column
        btn_width = 80
        btn_height = 26
        # Place within the row frame
        btn.place(x=855, y=btn_height/2, width=btn_width, height=btn_height)
        action_buttons.append(btn)


def delete_student(index: int) -> None:
    try:
        students.pop(index)
        save_students_to_csv()
        render_students()
    except Exception:
        pass


def open_add_student_window() -> None:
    # Toplevel form for adding a student
    win = Toplevel(window)
    win.title("Add Student")
    win.geometry("360x260")
    win.resizable(False, False)

    Label(win, text="Student ID:").place(x=10, y=10)
    id_entry = Entry(win)
    id_entry.place(x=110, y=10, width=220)

    Label(win, text="Name:").place(x=10, y=50)
    name_entry = Entry(win)
    name_entry.place(x=110, y=50, width=220)

    Label(win, text="Course:").place(x=10, y=90)
    course_entry = Entry(win)
    course_entry.place(x=110, y=90, width=220)

    Label(win, text="Location:").place(x=10, y=130)
    loc_var = StringVar(value="Up")
    OptionMenu(win, loc_var, "Up", "Down").place(x=110, y=125, width=120)

    def on_save() -> None:
        sid = id_entry.get().strip()
        name = name_entry.get().strip()
        course = course_entry.get().strip()
        location = loc_var.get().strip()
        if not sid:
            messagebox.showwarning("Validation", "Student ID is required.")
            return
        # Append and save
        students.append({"student_id": sid, "name": name, "course": course, "location": location})
        save_students_to_csv()
        render_students()
        try:
            win.destroy()
        except Exception:
            pass

    Button(win, text="Save", command=on_save).place(x=110, y=180, width=80)
    Button(win, text="Cancel", command=win.destroy).place(x=200, y=180, width=80)


def open_edit_student_window(index: int) -> None:
    # Edit an existing student; the Delete action is available here
    try:
        s = students[index]
    except Exception:
        return

    win = Toplevel(window)
    win.title("Edit Student")
    win.geometry("360x300")
    win.resizable(False, False)

    Label(win, text="Student ID:").place(x=10, y=10)
    id_entry = Entry(win)
    id_entry.place(x=110, y=10, width=220)
    id_entry.insert(0, s.get("student_id", ""))

    Label(win, text="Name:").place(x=10, y=50)
    name_entry = Entry(win)
    name_entry.place(x=110, y=50, width=220)
    name_entry.insert(0, s.get("name", ""))

    Label(win, text="Course:").place(x=10, y=90)
    course_entry = Entry(win)
    course_entry.place(x=110, y=90, width=220)
    course_entry.insert(0, s.get("course", ""))

    Label(win, text="Location:").place(x=10, y=130)
    loc_var = StringVar(value=s.get("location", "Up"))
    OptionMenu(win, loc_var, "Up", "Down").place(x=110, y=125, width=120)

    def on_save() -> None:
        sid = id_entry.get().strip()
        name = name_entry.get().strip()
        course = course_entry.get().strip()
        location = loc_var.get().strip()
        if not sid:
            messagebox.showwarning("Validation", "Student ID is required.")
            return
        students[index] = {"student_id": sid, "name": name, "course": course, "location": location}
        save_students_to_csv()
        render_students()
        try:
            win.destroy()
        except Exception:
            pass

    def on_delete() -> None:
        if messagebox.askyesno("Confirm", "Delete this student?"):
            try:
                students.pop(index)
                save_students_to_csv()
                render_students()
            except Exception:
                pass
            try:
                win.destroy()
            except Exception:
                pass

    Button(win, text="Save", command=on_save).place(x=80, y=220, width=80)
    Button(win, text="Delete", command=on_delete).place(x=170, y=220, width=80)
    Button(win, text="Cancel", command=win.destroy).place(x=260, y=220, width=80)


# Load any existing students and render them
load_students_from_csv()
render_students()
window.resizable(False, False)
window.mainloop()
